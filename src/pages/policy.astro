---
import LayoutOuter from "../layouts/LayoutOuter.astro";
import Basics from "../components/basics.astro";
import Protocol from "../components/protocol.astro";
import Energy from "../components/energy.astro";
import Cost from "../components/cost.astro";
---
<LayoutOuter title="Austausch Klimaanlage - Maßnahme Details">
	<a href="/" id="return">Zurück zur Übersicht</a>
	<h2>Austausch Klimaanlage</h2>
	<nav>
		<a>Basisdaten</a>
		<a>Bearbeitung</a>
		<a>Energieeffizienz</a>
		<a>Wirtschaftlichkeit</a>
	</nav>
	<div class="tab-container">
		<Basics />
		<Protocol />
		<Energy />
		<Cost />
	</div>
</LayoutOuter>

<script>
	//#region Tab Handling
	let tabLinks = document.getElementsByTagName("nav")[0].children;
	for (let i = 0; i < tabLinks.length; i++) {
		tabLinks[i].addEventListener("click", function() {
			switchTab(i);
		});
	}

	switchTab(0);

	function switchTab(tabNumber:number) {
		let tabs = document.getElementsByClassName("tab-content");
		
		for (let i = 0; i < tabs.length; i++) {
			tabs[i].classList.remove("active");
			tabLinks[i].classList.remove("active");
		}
		tabs[tabNumber].classList.add("active");
		document.getElementsByTagName("nav")[0].children[tabNumber].classList.add("active");
	}
	//#endregion

	class savingsGroup {
		powerToCo2Ratio:number;
		powerToCostRatio:number;
		energySavings:number;
		powerRatio:number;
		inputElement:HTMLInputElement;
		outputElement:NodeListOf<Element>;

		constructor(powerToCo2Ratio:number, powerToCostRatio:number, powerRatio:number, groupElement:Element) {
			this.energySavings = 0;
			this.powerRatio = powerRatio;
			this.powerToCo2Ratio = powerToCo2Ratio;
			this.powerToCostRatio = powerToCostRatio;
			this.outputElement = groupElement.querySelectorAll(".output");
			this.inputElement = (groupElement.querySelector(".inputEnergy") as HTMLInputElement);
			this.inputElement.addEventListener("focusout", () => { this.parseEnergy(this.inputElement); parseEnergyTotal();});
			this.inputElement.addEventListener("change", () => { this.parseEnergy(this.inputElement); parseEnergyTotal();});
			this.parseEnergy(this.inputElement);
		}

		parseEnergy(inputElement:HTMLInputElement):void {
			let newValue = parseFloat(inputElement.value);
			if(isNaN(newValue)) {
				return;
			}
			this.energySavings = newValue * this.powerRatio;
			(this.outputElement[0] as HTMLElement).innerText = Math.round(this.energySavings) + " kWh";
			(this.outputElement[1] as HTMLElement).innerText = Math.round(this.energySavings * this.powerToCo2Ratio) + " kg";
			(this.outputElement[2] as HTMLElement).innerText = Math.round(this.energySavings * this.powerToCostRatio) + " €";
		}

		//#region getters
		get savingsEnergy():number {
			return this.energySavings;
		}

		get savingsCo2():number {
			return this.energySavings * this.powerToCo2Ratio;
		}

		get savingsCost():number {
			return this.energySavings * this.powerToCostRatio;
		}
		//#endregion
	}


	let inputsEnergy:Array<savingsGroup> = [
		new savingsGroup(0.5801, 0.21, 1, (document.querySelector("#tabEnergy .main-content .details-grouping:nth-of-type(1)") as Element)),
		new savingsGroup(0.3251, 0.25, 11.5, (document.querySelector("#tabEnergy .main-content .details-grouping:nth-of-type(2)") as Element))
	];
	
	function parseEnergyTotal():void {
		let totalEnergySavings:number = 0;
		let totalMoneySavings:number = 0;
		let totalCo2Savings:number = 0;
		for(let i = 0; i < inputsEnergy.length; i++) {
			totalEnergySavings += inputsEnergy[i].savingsEnergy;
			totalMoneySavings += inputsEnergy[i].savingsCost;
			totalCo2Savings += inputsEnergy[i].savingsCo2;
		}

		let outputElements = document.querySelectorAll("#tabEnergy .sidebar .output");
		(outputElements[0] as HTMLElement).innerText = Math.round(totalEnergySavings) + " kWh";
		(outputElements[1] as HTMLElement).innerText = Math.round(totalCo2Savings) + " kg";
		(outputElements[2] as HTMLElement).innerText = Math.round(totalMoneySavings) + " €";
	}
	parseEnergyTotal();

	/*let inputsCost = document.getElementsByClassName("inputCost");
	for (let i = 0; i < inputsCost.length; i++) {
		inputsCost[i].addEventListener("focusout", parseCost);
		inputsCost[i].addEventListener("change", parseCost);
	}*/

	function parseCost():void {

	}
	//#endregion
</script>

<style>
	#return {
		font-size: 12px;
		margin-left: 6px;
	}

	#return::before {
		content: "\2329";
        display: inline-block;
        font-weight: normal;
        transform: translate(-5px, -1px);
	}

	.tab-container {
		flex-grow: 1;
		display: flex;
		flex-direction: column;
		align-items: stretch;
	}

	nav {
		display: flex;
		flex-direction: row;
		gap: 0;
		box-shadow: inset 0 -1px 0 0 var(--borders);
	}

	nav a {
		font-size: 16px;
		text-decoration: none;
		padding: 10px 20px;
		color: var(--text-light);
	}

	nav a:hover {
		color: var(--text);
		cursor: pointer;
	}

	nav a.active {
		color: var(--text);
		background-color: #f3f3f3;
		border: var(--borders) 1px solid;
		border-radius: 5px 5px 0 0;
		border-bottom: none;
		cursor: default;
	}
</style>